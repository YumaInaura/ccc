#!/usr/bin/env bash -eu

# Usuage
#
# $ eco docker rmi
#

# readonly current_directory=$(echo "$0" | sed -e "s/\/$(basename "$0")$//g")
readonly eco_home=${ECO_HOME:-"$HOME/eco"}

commands=''
options=''

for arg in $@; do
  # Start with alphabet is command
  if [[ "$arg" =~ ^[a-z] ]]; then commands="$commands $arg"; fi
  # Start with hyphen is option
  if [[ "$arg" =~ ^- ]]; then options="$options $arg"; fi
done

commands=$(echo $commands | perl -pe 's/^ //')
options=$(echo $options | perl -pe 's/^ //')

readonly file_name=$(basename "$0")
readonly script_file_name=$(echo "$commands" | perl -pe 's/ +/\//g');
readonly script_full_path="$eco_home/bin/$script_file_name"

if [[ "$@" =~ --dry ]]; then
  echo "**** Detail ****" 
  for name in eco_home commands options script_file_name script_full_path; do
    echo "$name" $(eval echo '$'"$name")
  done
fi

if [[ -f "$script_full_path" ]]; then
  eval "$script_full_path" "$options"
else
  echo "$ $commands $options"
  echo "command not found"

  part_of_command=$(echo "$@" | perl -pe 's/^\s*([a-z][a-z0-9]+)(.+?|$)/$1/g')

  find "$eco_home/bin" | \
    sed -E 's/bin(\/|$)/ / ' | \
    sed 's/\// /g' | \
    sed -E 's/[^0-9A-Za-z_ \/]//g' | \
    sed -E 's/^ +| +$//g' | \
    grep -e "^$part_of_command" | \
    sed -E 's/^/\$ eco /' | \
    sed -E 's/ +/ /g'
fi

